import {
  CONSTANTS,
  I_FRAME_ID,
  MESSAGE_EVENT_LIST,
  FLAGS,
  EVENTS_NAME,
} from './constants.js';
import * as UC from './event.js';
import gsService from './getter-setter.js';
let loadIframeAsync = (iframe) => {
  return new Promise((resolve, reject) => {
    iframe.onload = () => resolve(iframe);
    iframe.onerror = () => reject(new Error('Failed to load iframe'));
  });
};
let createIframe = async () => {
  self.iframe = document.getElementById(I_FRAME_ID);
  if (self.iframe) {
  } else {
    self.iframe = document.createElement('iframe');
    self.iframe.width = '600'; // Set the width of the iframe
    self.iframe.height = '400'; // Set the height of the iframe
    self.iframe.style.border = 'none'; // Optional: Remove the border
    self.iframe.style.display = 'none'; // Optional: hide it
    self.iframe.src = import.meta.env.VITE_IFRAME_URL;
    self.iframe.id = I_FRAME_ID;
    document.body.appendChild(self.iframe);
    // Wait for the iframe to load
    await loadIframeAsync(iframe); // Replace with your desired URL
    // console.log('Iframe loaded successfully', self.iframe);
  }
  return self.iframe;
};

function setCookies(data) {
  // childFrame
  postMessageMethod(MESSAGE_EVENT_LIST.SET_USER_PROFILE_TO_IFRAME, data);
}

let postMessageMethod = (name, data) => {
  self.iframe.contentWindow.postMessage(
    {
      name,
      data,
    },
    '*',
  );
};
let getCookie = () => {
  postMessageMethod(MESSAGE_EVENT_LIST.GET_USER_PROFILE_FROM_IFRAME);
  //   return localStorage.getItem(CONSTANTS.USER_PROFILE);
};

let getUDIDFromIframe = () => {
  postMessageMethod(MESSAGE_EVENT_LIST.GET_UDID_FROM_IFRAME);
};
let sendUDIDToIframe = (udid) => {
  postMessageMethod(MESSAGE_EVENT_LIST.SEND_UDID_TO_IFRAME, udid);
};

let getUTIDFromIframe = () => {
  postMessageMethod(MESSAGE_EVENT_LIST.GET_UTID_FROM_IFRAME);
};
let getUFIDFromIframe = () => {
  postMessageMethod(MESSAGE_EVENT_LIST.GET_UFID_FROM_IFRAME);
};
let getThirdPartyCookieStatusFromIframe = () => {
  postMessageMethod(
    MESSAGE_EVENT_LIST.GET_THIRD_PARTY_COOKIE_STATUS_FROM_IFRAME,
  );
};

let handleMessageEvent = (event) => {
  // Ensure the message is from the expected origin (if known)
  if (event.origin !== window.location.origin) {
    // console.log('Origin is different in Parent Message Handler');
  }

  // Access the data received from the parent
  switch (event?.data?.name) {
    // case MESSAGE_EVENT_LIST.GET_USER_PROFILE_FROM_IFRAME: {
    //   console.log(getUserProfile(), 'getUserProfile()');
    //   break;
    // }
    case MESSAGE_EVENT_LIST.SEND_USER_PROFILE_TO_PARENT: {
      if (
        event?.data?.data &&
        Object.keys(event?.data?.data).length &&
        FLAGS.OVERRIDE_UC_SESSION
        // !gsService.getUMID() && // Need to discuss this point
      ) {
        UC.event(EVENTS_NAME.UPDATE_USER_PROFILE, event.data.data);
        if (event?.data?.data?.u_mid) {
          gsService.setUMID(event?.data?.data?.u_mid);
        }
      }
      break;
    }
    case MESSAGE_EVENT_LIST.SEND_UDID_TO_PARENT: {
      gsService.setUDID(event?.data?.data);
      break;
    }
    case MESSAGE_EVENT_LIST.SEND_UTID_TO_PARENT: {
      gsService.setUTID(event?.data?.data);
      break;
    }
    case MESSAGE_EVENT_LIST.SEND_UFID_TO_PARENT: {
      gsService.setUFID(event?.data?.data);
      break;
    }
    case MESSAGE_EVENT_LIST.SEND_THIRD_PARTY_COOKIE_STATUS_TO_PARENT: {
      gsService.setThirdPartyCookieStatus(event?.data?.data);
      break;
    }

    default: {
      //   console.log('Default print');
    }
  }
};

export {
  createIframe,
  getCookie as getIframeCookie,
  setCookies as setIframeCookie,
  handleMessageEvent,
  getUDIDFromIframe,
  getUFIDFromIframe,
  getUTIDFromIframe,
  sendUDIDToIframe,
  getThirdPartyCookieStatusFromIframe,
};
