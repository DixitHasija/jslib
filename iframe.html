Universal Cookies
<!-- <button onclick="sendData()">Send Data</button> -->
<script type="module">
  import {
    CONSTANTS,
    MESSAGE_EVENT_LIST,
    LOCALSTORAGE_KEY,
  } from './src/constants.js';
  import {
    getRandomUUID,
    setCookie,
    getCookie,
    removeCookie,
  } from './src/utils.js';
  import FingerprintJS from './src/fp.esm.js';
  import {
    getFingerprint as ThumbmarkjsGetFingerprintObject,
    setOption,
  } from '@thumbmarkjs/thumbmarkjs';

  window.addEventListener('message', async function (event) {
    // Ensure the message is from the expected origin (if known)
    if (event.origin !== window.location.origin) {
      // return;
      // console.log('Origin is different in iframe');
    }
    // Access the data received from the parent
    switch (event?.data?.name) {
      case MESSAGE_EVENT_LIST.GET_USER_PROFILE_FROM_IFRAME: {
        getUserProfile();
        break;
      }

      case MESSAGE_EVENT_LIST.SEND_USER_PROFILE_TO_PARENT: {
        break;
      }
      case MESSAGE_EVENT_LIST.SET_USER_PROFILE_TO_IFRAME: {
        setData(event?.data?.data);
        break;
      }
      case MESSAGE_EVENT_LIST.GET_UDID_FROM_IFRAME: {
        let UDID = getCookie(CONSTANTS.UDID);
        if (!UDID) {
          UDID = getRandomUUID();
          setCookie(CONSTANTS.UDID, UDID);
        }
        postMessageMethod(MESSAGE_EVENT_LIST.SEND_UDID_TO_PARENT, UDID);
        break;
      }
      case MESSAGE_EVENT_LIST.SEND_UDID_TO_IFRAME: {
        let UDID = event?.data?.data;
        if (UDID) {
          setCookie(CONSTANTS.UDID, UDID);
        }
        break;
      }
      case MESSAGE_EVENT_LIST.GET_UTID_FROM_IFRAME: {
        let UTID = getCookie(CONSTANTS.UTID);
        if (!UTID) {
          const ThumbmarkJsObject = await getThumbmarkJs();
          UTID = ThumbmarkJsObject.hash;
          setCookie(CONSTANTS.UTID, UTID);
        }
        postMessageMethod(MESSAGE_EVENT_LIST.SEND_UTID_TO_PARENT, UTID);
        break;
      }

      case MESSAGE_EVENT_LIST.GET_UFID_FROM_IFRAME: {
        let UFID = getCookie(CONSTANTS.UFID);
        if (!UFID) {
          const FingerprintObject = await getFingerprintObject();
          UFID = FingerprintObject?.visitorId;
          setCookie(CONSTANTS.UFID, UFID);
        }
        postMessageMethod(MESSAGE_EVENT_LIST.SEND_UFID_TO_PARENT, UFID);
        break;
      }
      case MESSAGE_EVENT_LIST.GET_THIRD_PARTY_COOKIE_STATUS_FROM_IFRAME: {
        setCookie(CONSTANTS.TEMPORARY_COOKIE, '1');
        //  document.cookie = "test_cookie=1";
        if (document.cookie.indexOf(CONSTANTS.TEMPORARY_COOKIE) !== -1) {
          postMessageMethod(
            MESSAGE_EVENT_LIST.SEND_THIRD_PARTY_COOKIE_STATUS_TO_PARENT,
            false,
          );
          removeCookie(CONSTANTS.TEMPORARY_COOKIE);
        } else {
          postMessageMethod(
            MESSAGE_EVENT_LIST.SEND_THIRD_PARTY_COOKIE_STATUS_TO_PARENT,
            true,
          );
        }
      }

      default: {
        // console.log('Default print');
      }
    }
  });

  // const domain = 'jslib-dixithasijas-projects.vercel.app';//Not in use
  // const domain = 'sr-cdn.shiprocket.in';//Not in use

  let getUserProfile = () => {
    let userProfile = '';
    // if (self?.localStorage && self?.localStorage[LOCALSTORAGE_KEY]) {
    //   userProfile = JSON.parse(self?.localStorage[LOCALSTORAGE_KEY]);
    // }
    userProfile = getCookie(CONSTANTS.USER_PROFILE);
    if (userProfile) {
      postMessageMethod(
        MESSAGE_EVENT_LIST.SEND_USER_PROFILE_TO_PARENT,
        JSON.parse(userProfile),
      );
    }
  };

  let setData = (data) => {
    setCookie(CONSTANTS.USER_PROFILE, JSON.stringify(data));
    // if (self?.localStorage && self?.localStorage[LOCALSTORAGE_KEY]) {
    // } else {
    //   self?.localStorage.setItem(LOCALSTORAGE_KEY, '{}');
    // }
    // const userProfile = JSON.parse(
    //   self?.localStorage[LOCALSTORAGE_KEY],
    // );
    // userProfile[CONSTANTS.USER_PROFILE] = data;
    // self?.localStorage.setItem(
    //   LOCALSTORAGE_KEY,
    //   JSON.stringify(userProfile),
    // );
  };

  let postMessageMethod = (name, data) => {
    self?.parent?.postMessage(
      {
        name,
        data,
      },
      '*',
    );
  };

  let getFingerprintObject = async () => {
    // const fp = await import('https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs/+esm')
    // .then(FingerprintJS => FingerprintJS.load({
    //     region: "ap",
    //     apiKey: "w19U95D41ZRuBaTVhebA",
    // }));

    const fp = await FingerprintJS.load({
      apiKey: 'w19U95D41ZRuBaTVhebA',
      region: 'ap',
    });
    const result = await fp.get();
    return result;
  };

  async function getThumbmarkJs() {
    setOption('exclude', ['permissions']);
    return ThumbmarkjsGetFingerprintObject(true).then((fp) => fp);
  }
</script>
